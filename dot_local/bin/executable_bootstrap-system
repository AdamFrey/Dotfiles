#!/bin/bash

if ! command -v awesome &> /dev/null
then
    rpm-ostree intsall awesome
fi


if ! command -v kitty &> /dev/null
then
    rpm-ostree install kitty
fi


if ! command -v rofi &> /dev/null
then
    rpm-ostree install rofi
fi

if ! command -v zsh &> /dev/null
then
    rpm-ostree install zsh zsh-autosuggestions zsh-syntax-highlighting
fi

if ! command -v emacs  &> /dev/null
then
    rpm-ostree install emacs
fi

if ! command -v flameshot  &> /dev/null
then
    rpm-ostree install flameshot
fi

if ! command -v direnv &> /dev/null
then
    rpm-ostree install direnv
fi

if ! command -v dunst &> /dev/null
then
    rpm-ostree install dunst
fi



# https://universal-blue.org/images/nvidia/
# rpm-ostree kargs \
#     --append=rd.driver.blacklist=nouveau \
#     --append=modprobe.blacklist=nouveau \
#     --append=nvidia-drm.modeset=1
#
# See https://universal-blue.org/images/nvidia/#video-playback

# I ran this but I don't think it was necessary. The beep was coming from kitty
# sudo rmmod pcspkr

# set zsh as shell
if ! cat /etc/passwd | grep $USER | grep zsh &> /dev/null
then
    echo "change shell to /bin/zsh"
    sudo lchsh $USER
fi

if [ ! -d /usr/share/fonts/jetbrains-mono-fonts ]
then
    # system fonts are in /usr/share/fonts
    rpm-ostree install jetbrains-mono-fonts
    # emacs font cache has may have to be busted after this
    systemctl reboot
fi

if [ ! -f ~/.ssh/config ]
then
    echo "generate new ssh key or copy from existing machine"
    echo "scp -r <old-machine>:~/.ssh ~/.ssh"
    exit 1
fi

# distroboxes

dbox_create() {
    if ! distrobox list | grep $1 &> /dev/null
    then
	distrobox create --name $1 -i archlinux:latest
    fi
}

cntr_desktop=desktop-tools
dbox_create $cntr_desktop

cntr_devtools=devtools
dbox_create $cntr_devtools

distrobox-enter -n $cntr_desktop -e ~/.config/distrobox/desktop-tools-bootstrap.sh
distrobox-enter -n $cntr_devtools -e ~/.config/distrobox/devtools-bootstrap.sh
#dbox_install ripgrep $cntr_devtools rg
# TODO add fasd to desktop tools

# dotfiles

chez_local=~/.local/share/chezmoi
chez_remote_http=https://github.com/AdamFrey/dotfiles.git
chez_remote_ssh=git@github.com:AdamFrey/dotfiles.git
if ! ls $chez_local | grep dot_config &> /dev/null
then
    rm -rf $chez_local
    git clone $chez_remote_ssh $chez_local
    chezmoi update

    echo "chezmoi init"
fi

rm -rf ~/.emacs.d

if ! cat ~/.config/emacs/README.md | grep "Doom Emacs" &> /dev/null
then    
    git clone --depth 1 https://github.com/doomemacs/doomemacs ~/.config/emacs
    ~/.config/emacs/bin/doom install
fi

# flatpaks

flatpak_i () {
    if ! flatpak info $1 &> /dev/null
    then
        flatpak install flathub $1
    fi
}

flatpak_rm () {
    if flatpak info $1 &> /dev/null
    then
        flatpak uninstall $1
    fi
}

symlink () {
    if [ ! -e $2 ]
    then
        ln -s $1 $2
    fi
}

# https://github.com/flatpak/flatpak/issues/3787#issuecomment-1044677820
# TODO get this working
mkdir -p ~/.var/app/com.slack.Slack/config/gtk-3.0
symlink /home/adam/.config/gtk-3.0/settings.ini ~/.var/app/com.slack.Slack/config/gtk-3.0/settings.ini
flatpak_i com.bitwarden.desktop
flatpak_i com.todoist.Todoist

xdg-settings set default-web-browser org.mozilla.firefox.desktop

# Systemd services

systemctl enable --user emacs

webpaks=(
    "com.google.Chrome"
    "com.spotify.Client"
    "org.mozilla.firefox"
    "fi.skyjake.Lagrange"
    "com.slack.Slack"
    "com.valvesoftware.Steam"
    "us.zoom.Zoom"
)

if [ "$1" = "--no-web" ]; then
    for pak in "${webpaks[@]}"; do
        flatpak_rm $pak
    done
else
    for pak in "${webpaks[@]}"; do
        flatpak_i $pak
    done
fi


# Folders

rmdir ~/Desktop &> /dev/null
rmdir ~/Documents &> /dev/null
rmdir ~/Downloads &> /dev/null
rmdir ~/Music &> /dev/null
rmdir ~/Pictures &> /dev/null
rmdir ~/Public &> /dev/null
rmdir ~/Templates &> /dev/null
rmdir ~/Videos &> /dev/null

mkdir -p ~/inbox
