#!/bin/bash

if ! command -v awesome &> /dev/null
then
    rpm-ostree intsall awesome
    systemctl reboot
fi


if ! command -v kitty &> /dev/null
then
    rpm-ostree install kitty
    systemctl reboot
fi


if ! command -v rofi &> /dev/null
then
    rpm-ostree install rofi
    systemctl reboot
fi

if ! command -v zsh &> /dev/null
then
    rpm-ostree install zsh zsh-autosuggestions zsh-syntax-highlighting
    systemctl reboot
fi

# I ran this but I don't think it was necessary. The beep was coming from kitty
# sudo rmmod pcspkr

# set zsh as shell
if ! cat /etc/passwd | grep $USER | grep zsh &> /dev/null
then
    echo "change shell to /bin/zsh"
    sudo lchsh $USER
fi

if [ ! -d /usr/share/fonts/jetbrains-mono-fonts ]
then
    # system fonts are in /usr/share/fonts
    rpm-ostree install jetbrains-mono-fonts
    # emacs font cache has may have to be busted after this
    systemctl reboot
fi

if [ ! -f ~/.ssh/config ]
then
    echo "generate new ssh key or copy from existing machine"
    echo "scp -r <old-machine>:~/.ssh ~/.ssh"
    exit 1
fi

# distroboxes

dbox_create() {
    if ! distrobox list | grep $1 &> /dev/null
    then
	distrobox create --name $1 -i archlinux:latest
    fi
}

cntr_desktop=desktop-tools
dbox_create $cntr_desktop

cntr_devtools=devtools
dbox_create $cntr_devtools

distrobox-enter -n $cntr_desktop -e ~/.config/distrobox/desktop-tools-bootstrap.sh
distrobox-enter -n $cntr_devtools -e ~/.config/distrobox/devtools-bootstrap.sh
#dbox_install ripgrep $cntr_devtools rg
# TODO add fasd to desktop tools

# dotfiles

chez_local=~/.local/share/chezmoi
chez_remote_http=https://github.com/AdamFrey/dotfiles.git
chez_remote_ssh=git@github.com:AdamFrey/dotfiles.git
if ! ls $chez_local | grep dot_config &> /dev/null
then
    rm -rf $chez_local
    git clone $chez_remote_ssh $chez_local
    chezmoi update

    echo "chezmoi init"
fi

rm -rf ~/.emacs.d

if ! cat ~/.config/emacs/README.md | grep "Doom Emacs" &> /dev/null
then    
    git clone --depth 1 https://github.com/doomemacs/doomemacs ~/.config/emacs
    ~/.config/emacs/bin/doom install
fi

# flatpaks

flatpak_i () {
    if ! flatpak info $1 &> /dev/null
    then
        flatpak install flathub $1
    fi
}

symlink () {
    if [ ! -e $2 ]
    then
        ln -s $1 $2
    fi
}

flatpak_i us.zoom.Zoom
flatpak_i com.slack.Slack
# https://github.com/flatpak/flatpak/issues/3787#issuecomment-1044677820
# TODO get this working
mkdir -p ~/.var/app/com.slack.Slack/config/gtk-3.0
symlink /home/adam/.config/gtk-3.0/settings.ini ~/.var/app/com.slack.Slack/config/gtk-3.0/settings.ini
flatpak_i com.bitwarden.desktop
flatpak_i com.spotify.Client
flatpak_i fi.skyjake.Lagrange
flatpak_i com.todoist.Todoist

xdg-settings set default-web-browser org.mozilla.firefox.desktop

# Systemd services

systemctl enable --user emacs
